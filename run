#!/bin/sh

if [ $# -eq 0 ]; then
	echo "No save name supplied"
	exit 1
fi

# link mod
ln -sf $(pwd)/fotograf_1.0.0 ~/.factorio/mods/

# use our mod list
mv ~/.factorio/mods/mod-list.json ~/.factorio/mods/mod-list.json.backup
cp ./mod-list.json ~/.factorio/mods/mod-list.json

# clear garbage from last time
rm ~/.factorio/script-output/images/ -rf
rm ~/.factorio/script-output/mapInfo.json -f
rm ~/.factorio/script-output/done -f

# load the save and generate the images
factorio --load-game $1 1> /dev/null&
echo "Waiting for the game to finish rendering..."
until [ -f ~/.factorio/script-output/done ]; do
     sleep 1
done
sleep 3
killall factorio


# make a copy of the web template
mkdir $1
cp ./web/index* $1/

# move the images and map info
mv ~/.factorio/script-output/images/      $1/
mv ~/.factorio/script-output/mapInfo.json $1/

printf "mapInfo = '" > $1/mapInfo.js
cat $1/mapInfo.json >> $1/mapInfo.js
printf "'" >> $1/mapInfo.js

# return original mod list
mv ~/.factorio/mods/mod-list.json.backup ~/.factorio/mods/mod-list.json

# generate a blank tile with the right size
imgres=$(cat $1/mapInfo.json | jq ".image_resolution")
convert blank.png -resize ${imgres}x${imgres} -colorspace RGB $1/images/blank.png

echo "map was successfully generated"
echo "generated web is in $(pwd)/$1/"
